rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Users Collection Rules
    match /users/{userId} {
      // Users can read their own profile, admins can read all profiles
      allow read: if isOwner(userId) || isAdmin();
      
      // Users can create their own profile during signup
      allow create: if isOwner(userId) && request.resource.data.role == 'user';
      
      // Users can update their own profile, BUT cannot modify sensitive fields directly
      allow update: if isOwner(userId) &&
        (!request.resource.data.diff(resource.data).affectedKeys()
          .hasAny(['role'])) || isAdmin();
          
      allow delete: if isAdmin();
    }

    // Wallets Subcollection Rules
    match /users/{userId}/wallet/{walletId} {
      // Read access
      allow read: if isOwner(userId) || isAdmin();
      
      // Increment transactions rely on this being true
      allow create, update: if isOwner(userId) || isAdmin();
      
      allow delete: if isAdmin();
    }

    // Books Collection Rules
    match /books/{bookId} {
      allow read: if isAuthenticated();
      allow create, delete: if isAdmin();
      
      // Allow user updates ONLY if it is solely changing availableCopies via Transaction
      allow update: if isAdmin() || (isAuthenticated() && 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['availableCopies']));
    }

    // Reservations Collection Rules
    match /reservations/{reservationId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      
      // Users can create a reservation record via Transaction
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // Users can update reservation ONLY for returning (changing status to returned, setting returnedAt and fineAmount)
      allow update: if isAdmin() || (isAuthenticated() && 
        resource.data.userId == request.auth.uid &&
        request.resource.data.diff(resource.data).affectedKeys()
        .hasAny(['status', 'returnedAt', 'fineAmount']) &&
        // Protect status from being changed to anything other than returned by user
        request.resource.data.status == 'returned' &&
        resource.data.status == 'active');
        
      allow delete: if isAdmin();
    }
  }
}
